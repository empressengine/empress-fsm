(function(n,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("empress-core")):typeof define=="function"&&define.amd?define(["exports","empress-core"],a):(n=typeof globalThis<"u"?globalThis:n||self,a(n.EmpressFSM={},n.empressCore))})(this,function(n,a){"use strict";var u=(c=>(c.Stop="stop",c.Wait="wait",c))(u||{});class _{constructor(t,s){this._executionController=t,this._currentExecutionId="",this._storeStates=[],this._transitionPromise=null,this._name=s.name,this._store=s.store,this._states=new Map,this._hooks=s.hooks,this._currentState=s.initialState,s.states.forEach(e=>{this._states.set(e.name,e)}),this._store.subscribe(async()=>{this.addStoreData(this._store),this.processTransition()})}get name(){return this._name}get store(){return this._store}get currentState(){return this._currentState}get states(){return this._states}get hooks(){return this._hooks||{}}async start(){var e;const t=this._states.get(this._currentState);if(!t)throw new Error(`Initial state '${this._currentState}' not found`);this.addStoreData(this._store),this._transitionPromise=new a.DeferredPromise;const s=this.getStoreData();s&&(await this.processOnEnter(this._currentState,"",s),t.subStates&&await t.subStates.start(),this._currentStateData=s,(e=this._transitionPromise)==null||e.resolve(),await this.processTransition())}async stop(){var s;const t=this._states.get(this._currentState);t&&(this._executionController.stop(this._currentExecutionId),(s=this._transitionPromise)==null||s.resolve(),this.processOnExit(this._currentState,this._currentStateData),t.subStates&&await t.subStates.stop(),this._store.subscribe(()=>{}))}async update(t){var e;const s=this._states.get(this._currentState);(s==null?void 0:s.transitionStrategy)===u.Stop&&this._executionController.stop(this._currentExecutionId),await((e=this._transitionPromise)==null?void 0:e.promise),this._store.update(t)}async waitForTransition(){var t;await((t=this._transitionPromise)==null?void 0:t.promise)}addStoreData(t){this._storeStates.push({current:t.cloneState(),prev:t.clonePrevState()})}getStoreData(t=!1){return t?this._storeStates.pop():this._storeStates.shift()}canTransit(t,s,e){const r=this._states.get(t);if(!r||!r.transitions)return null;for(const i of r.transitions)if(i.condition(s,e))return i.to;return null}async processTransition(){var e;const t=this.getStoreData();if(!t)return;const s=this.canTransit(this._currentState,t.current,t.prev);s&&(this._transitionPromise=new a.DeferredPromise,await this.transition(this._currentState,s,this._currentStateData,t),this._currentStateData=t,(e=this._transitionPromise)==null||e.resolve())}async transition(t,s,e,r){const i=this._states.get(t),o=this._states.get(s);if(!i||!o)throw new Error(`State '${t}' or '${s}' not found`);this.processOnExit(t,e),await this.processOnEnter(s,t,r),o.subStates&&o.subStates.start()}processOnExit(t,s){var h;const e=this._states.get(t);if(!e)throw new Error(`State '${t}' not found`);if(!e.onExit)return;const r={fsmName:this._name,from:t,to:"",data:s},i=`[FSM][onExit] In ${this._name} from ${t}}`,o=this._executionController.create(e.onExit,r,i);(h=this._hooks)!=null&&h.onExit&&this._hooks.onExit(r),this._executionController.run(o,!1)}async processOnEnter(t,s,e){var h;const r=this._states.get(t);if(!r)throw new Error(`State '${t}' not found`);if(!r.onEnter)return;const i={fsmName:this._name,from:s,to:t,data:e},o=`[FSM][onEnter] In ${this._name} from ${s} to ${t}`;this._currentExecutionId=this._executionController.create(r.onEnter,i,o),this._currentState=t,(h=this._hooks)!=null&&h.onEnter&&this._hooks.onEnter(i),await this._executionController.run(this._currentExecutionId)}}n.FSM=_,n.TransitionStrategy=u,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
