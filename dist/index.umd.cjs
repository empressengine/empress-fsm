(function(a,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("empress-core"),require("empress-store")):typeof define=="function"&&define.amd?define(["exports","empress-core","empress-store"],r):(a=typeof globalThis<"u"?globalThis:a||self,r(a.EmpressFSM={},a.empressCore,a.empressStore))})(this,function(a,r,f){"use strict";var c=(h=>(h.Stop="stop",h.Wait="wait",h))(c||{});class d extends r.SystemGroup{constructor(t){super(),this.chain=t}setup(t,e){}}class g extends r.SystemChain{clear(){}}class p{constructor(t,e){this._executionController=t,this._currentExecutionId="",this._storeStates=[],this._transitionPromise=null,this._isRunning=!1,this._name=e.name,this._storeAdapter=e.store,this._states=new Map,this._hooks=e.hooks,this._currentState=e.initialState,e.states.forEach(i=>{this._states.set(i.name,i)}),this._storeAdapter.subscribe(async()=>{this._isRunning&&(this.addStoreData(this._storeAdapter),this.processTransition())})}get name(){return this._name}get storeAdapter(){return this._storeAdapter}get store(){return console.warn("FSM.store is deprecated. Use FSM.storeAdapter instead."),{cloneState:()=>this._storeAdapter.getState(),clonePrevState:()=>this._storeAdapter.getPrevState(),update:t=>this._storeAdapter.update(t)}}get currentState(){return this._currentState}get states(){return this._states}get hooks(){return this._hooks||{}}async start(){var i;this._isRunning=!0;const t=this._states.get(this._currentState);if(!t)throw new Error(`Initial state '${this._currentState}' not found`);this.addStoreData(this._storeAdapter),this._transitionPromise=new r.DeferredPromise;const e=this.getStoreData();e&&(await this.processOnEnter(this._currentState,"",e),t.subStates&&await t.subStates.start(),this._currentStateData=e,(i=this._transitionPromise)==null||i.resolve(),await this.processTransition())}async stop(){var e;this._isRunning=!1;const t=this._states.get(this._currentState);t&&(this._executionController.stop(this._currentExecutionId),(e=this._transitionPromise)==null||e.resolve(),this.processOnExit(this._currentState,this._currentStateData),t.subStates&&await t.subStates.stop(),this._storeAdapter.unsubscribe())}async update(t){var i;if(!this._isRunning)return;const e=this._states.get(this._currentState);(e==null?void 0:e.transitionStrategy)===c.Stop&&this._executionController.stop(this._currentExecutionId),await((i=this._transitionPromise)==null?void 0:i.promise),this._storeAdapter.update(t)}async waitForTransition(){var t;await((t=this._transitionPromise)==null?void 0:t.promise)}addStoreData(t){this._storeStates.push({current:t.getState(),prev:t.getPrevState()})}getStoreData(t=!1){return t?this._storeStates.pop():this._storeStates.shift()}canTransit(t,e,i){if(!this._isRunning)return null;const s=this._states.get(t);if(!s||!s.transitions)return null;for(const n of s.transitions)if(n.condition(e,i))return n.to;return null}async processTransition(){var i;if(!this._isRunning)return;const t=this.getStoreData();if(!t)return;const e=this.canTransit(this._currentState,t.current,t.prev);e&&(this._transitionPromise=new r.DeferredPromise,await this.transition(this._currentState,e,this._currentStateData,t),this._currentStateData=t,(i=this._transitionPromise)==null||i.resolve())}async transition(t,e,i,s){const n=this._states.get(t),o=this._states.get(e);if(!n||!o)throw new Error(`State '${t}' or '${e}' not found`);this.processOnExit(t,i),await this.processOnEnter(e,t,s),o.subStates&&o.subStates.start()}processOnExit(t,e){var u;const i=this._states.get(t);if(!i)throw new Error(`State '${t}' not found`);if(!i.onExit)return;const s={fsmName:this._name,from:t,to:"",data:e},n=`[FSM][onExit] In ${this._name} from ${t}}`,o=this.extractGroups(i.onExit,s),_=this._executionController.create(o,s,n);(u=this._hooks)!=null&&u.onExit&&this._hooks.onExit(s),this._executionController.run(_,!1)}async processOnEnter(t,e,i){var u;const s=this._states.get(t);if(!s)throw new Error(`State '${t}' not found`);if(!s.onEnter)return;const n={fsmName:this._name,from:e,to:t,data:i},o=`[FSM][onEnter] In ${this._name} from ${e} to ${t}`,_=this.extractGroups(s.onEnter,n);this._currentExecutionId=this._executionController.create(_,n,o),this._currentState=t,(u=this._hooks)!=null&&u.onEnter&&this._hooks.onEnter(n),await this._executionController.run(this._currentExecutionId)}extractGroups(t,e){if(typeof t=="function"){const i=new g;t(i,e);const s=new d(i);return r.ServiceContainer.instance.get(r.GroupsContainer).set(d,s),[d]}else return t}}class E{constructor(t){this._store=t,this._unsubscribeFn=()=>{}}get store(){return this._store}getState(){return this._store.cloneState()}getPrevState(){return this._store.clonePrevState()}update(t){this._store.update(t)}subscribe(t){return this._unsubscribeFn=this._store.subscribe(t),this._unsubscribeFn}unsubscribe(){this._unsubscribeFn()}}class S{create(t){const e=new f.Store(t);return new E(e)}}class l{constructor(t,e){this._name=t,this._store=e,this._config={name:"",store:new S().create({}),initialState:"",states:[]},this._onEnterChains=new Map,this._onEnterGroups=new Map,this._onExitChains=new Map,this._onExitGroups=new Map,this._editedState=null,this._config.name=this._name,this._config.store=this._store}get config(){return this._config}setInitialState(t){return this._config.initialState=t,this}addState(t){return this._editedState={name:t,onEnter:[],onExit:[],transitions:[]},this._config.states.push(this._editedState),this}removeState(t){return this._config.states=this._config.states.filter(e=>e.name!==t),this._editedState=null,this._onEnterChains.delete(t),this._onExitChains.delete(t),this._onEnterGroups.delete(t),this._onExitGroups.delete(t),this}addSubStates(t){if(!this._editedState)throw new Error("State is not edited");return this._editedState.subStates=t,this}removeSubStates(t){return this._config.states=this._config.states.map(e=>(e.name===t&&(e.subStates=void 0),e)),this}replaceSubStates(t,e){return this._config.states=this._config.states.map(i=>(i.name===t&&(i.subStates=e),i)),this}addTransition(t,e){var i;if(!this._editedState)throw new Error("State is not edited");return(i=this._editedState.transitions)==null||i.push({to:t,condition:e}),this}removeTransition(t,e){return this._config.states=this._config.states.map(i=>{var s;return i.name===t&&(i.transitions=(s=i.transitions)==null?void 0:s.filter(n=>n.to!==e)),i}),this}replaceTransition(t,e,i){return this._config.states=this._config.states.map(s=>{var n;return s.name===t&&(s.transitions=(n=s.transitions)==null?void 0:n.map(o=>o.to===e?{to:e,condition:i}:o)),s}),this}addOnEnterChain(t){if(!this._editedState)throw new Error("State is not edited");return this._onEnterChains.set(this._editedState.name,t),this}addOnExitChain(t){if(!this._editedState)throw new Error("State is not edited");return this._onExitChains.set(this._editedState.name,t),this}removeOnEnterChain(t){return this._onEnterChains.delete(t),this}removeOnExitChain(t){return this._onExitChains.delete(t),this}replaceOnEnterChain(t,e){return this._onEnterChains.set(t,e),this}replaceOnExitChain(t,e){return this._onExitChains.set(t,e),this}addOnEnterGroup(t,e=r.Utils.uuid()){if(!this._editedState)throw new Error("State is not edited");const i=this._onEnterGroups.get(this._editedState.name)||[];return i.push({action:t,id:e}),this._onEnterGroups.set(this._editedState.name,i),this}addOnEnterGroupToState(t,e,i=r.Utils.uuid()){const s=this._onEnterGroups.get(t)||[];return s.push({action:e,id:i}),this._onEnterGroups.set(t,s),this}addOnEnterGroupBefore(t,e,i,s=r.Utils.uuid()){const n=this._onEnterGroups.get(t)||[];return n.splice(n.findIndex(o=>o.id===e),0,{action:i,id:s}),this._onEnterGroups.set(t,n),this}addOnEnterGroupAfter(t,e,i,s=r.Utils.uuid()){const n=this._onEnterGroups.get(t)||[];return n.splice(n.findIndex(o=>o.id===e)+1,0,{action:i,id:s}),this._onEnterGroups.set(t,n),this}addOnEnterGroupToStart(t,e,i=r.Utils.uuid()){const s=this._onEnterGroups.get(t)||[];return s.unshift({action:e,id:i}),this._onEnterGroups.set(t,s),this}addOnExitGroup(t,e=r.Utils.uuid()){if(!this._editedState)throw new Error("State is not edited");const i=this._onExitGroups.get(this._editedState.name)||[];return i.push({action:t,id:e}),this._onExitGroups.set(this._editedState.name,i),this}addOnExitGroupToState(t,e,i=r.Utils.uuid()){const s=this._onExitGroups.get(t)||[];return s.push({action:e,id:i}),this._onExitGroups.set(t,s),this}addOnExitGroupBefore(t,e,i,s=r.Utils.uuid()){const n=this._onExitGroups.get(t)||[];return n.splice(n.findIndex(o=>o.id===e),0,{action:i,id:s}),this._onExitGroups.set(t,n),this}addOnExitGroupAfter(t,e,i,s=r.Utils.uuid()){const n=this._onExitGroups.get(t)||[];return n.splice(n.findIndex(o=>o.id===e)+1,0,{action:i,id:s}),this._onExitGroups.set(t,n),this}addOnExitGroupToStart(t,e,i=r.Utils.uuid()){const s=this._onExitGroups.get(t)||[];return s.unshift({action:e,id:i}),this._onExitGroups.set(t,s),this}removeOnEnterGroup(t,e){let i=this._onEnterGroups.get(t);return i?(i=i.filter(s=>s.id!==e),this._onEnterGroups.set(t,i),this):this}removeOnExitGroup(t,e){let i=this._onExitGroups.get(t);return i?(i=i.filter(s=>s.id!==e),this._onExitGroups.set(t,i),this):this}replaceOnEnterGroup(t,e,i){let s=this._onEnterGroups.get(t);return s?(s=s.map(n=>n.id===e?{action:i,id:e}:n),this._onEnterGroups.set(t,s),this):this}replaceOnExitGroup(t,e,i){let s=this._onExitGroups.get(t);return s?(s=s.map(n=>n.id===e?{action:i,id:e}:n),this._onExitGroups.set(t,s),this):this}build(){const t=r.ServiceContainer.instance.get(r.ExecutionController);return this.validateInitialState(),this.validateTransitions(),this._config.states.forEach(e=>{this.buildOnEnterActions(e),this.buildOnExitActions(e)}),new p(t,this._config)}buildOnEnterActions(t){var s;t.onEnter=[];const e=this._onEnterChains.get(t.name);e&&(t.onEnter=e);const i=(s=this._onEnterGroups.get(t.name))==null?void 0:s.map(n=>n.action);if(e&&i)throw new Error("OnEnter actions for state "+t.name+" has both chains and groups!");i&&(t.onEnter=i)}buildOnExitActions(t){var s;t.onExit=[];const e=this._onExitChains.get(t.name);e&&(t.onExit=e);const i=(s=this._onExitGroups.get(t.name))==null?void 0:s.map(n=>n.action);if(e&&i)throw new Error("OnExit actions for state "+t.name+" has both chains and groups!");i&&(t.onExit=i)}validateInitialState(){if(!this._config.initialState)throw new Error("Initial state is not set!");if(!this._config.states.find(t=>t.name===this._config.initialState))throw new Error("State "+this._config.initialState+" cannot be initial state, because it does not exist!")}validateTransitions(){for(let t=0;t<this._config.states.length;t++){const e=this._config.states[t];if(e.transitions)for(let i=0;i<e.transitions.length;i++){const s=e.transitions[i];if(!this._config.states.find(n=>n.name===s.to))throw new Error("Can't transit to "+s.to+" from "+e.name+" because it does not exist!")}}}}class x{create(t,e){return this._builder=new l(t,e),this.setup(this._builder),this._builder.build()}getConfig(){return this._builder.config}}a.EmpressStoreAdapter=E,a.EmpressStoreFactory=S,a.FSM=p,a.FSMBuilder=l,a.FSMFactory=x,a.TransitionStrategy=c,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
